<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Link</title>
    <link rel="stylesheet" type="text/css" href="../static/style/bootstrap-4.4.1.min.css"/>
    <link rel="stylesheet" type="text/css" href="../static/style/style.css"/>
    <link rel="stylesheet" type="text/css" href="../static/style/styleLink.css"/>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../static/js/jquery-3.4.1.min.js"></script>
    <script src="../static/js/howler.min.js"></script>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
</head>

<body>

<div class="main card">
    <div class="row">
        <div class="col-12">
            Tempo<br/>
            <span id="tempo"></span>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            Beat<br/>
            <span id="beat"></span>
        </div>
        <div class="col-6">
            Phase<br/>
            <span id="phase"></span>
        </div>
    </div>
</div>

<div id="audioSwitchCard" class="card" onclick="audioToggle()">
    <h5 id="audioSwitchLabel">Audio OFF</h5>
</div>


<div id="light" class="blink">
</div>


<footer></footer>
</body>


<script type="application/javascript">
    $.ajax({
        url: window.location.href.substring(0, window.location.href.length - 4) + "footer",
        type: 'get',
        success: function (response) {
            // Add response in mainPage
            $('footer').html(response);
        },
        async: true
    });

    //setup sound
    let sample;
    let latency = LATECY_TO_REPLACE;
    let latencyInBeat;
    let isAudioOn = false;

    let audioToggle = function () {
        if (isAudioOn === true) {
            $('#audioSwitchCard').removeClass("on");
            $('#audioSwitchLabel').html("Audio OFF");
            isAudioOn = false;
        } else {
            $('#audioSwitchCard').addClass("on");
            $('#audioSwitchLabel').html("Audio ON");
            isAudioOn = true;
            if (sample === undefined) {
                setup();
            }
        }
    }

    function setup() {
        sample = new Howl({src: ['../static/sounds/sample.mp3']});
    }

    //let mrNoisy = new p5.Noise();

    function blink() {
        const $blink = $('.blink');
        $blink.addClass("active");
        setTimeout(() => {
            $blink.removeClass("active");
        }, 100);
    }

    function beep() {
        if (isAudioOn === true) {
            try {
                sample.play();
            } catch (e) {
                console.log("not ready");
            }
        }
        //mrNoisy.start();
        //setTimeout(() => {
        //    mrNoisy.stop();
        //}, 50);
    }


    //setup socket.io
    const socket = io();
    let ready = false;
    let intBeat = -1;
    let intPhase = -1;
    let previousBeep = -1;

    socket.on('tempo', function (msg) {
        $('#tempo').html(msg);
        latencyInBeat = (msg/60)*latency;
        previousBeep = Math.ceil(msg) - latencyInBeat;
    });
    socket.on('phase', function (msg) {
        if (Math.floor(msg) !== intPhase) {
            intPhase = Math.floor(msg);
            $('#phase').html(intPhase);
        }
    });
    socket.on('beat', function (msg) {
        if (intBeat === -1) {
            previousBeep = Math.ceil(msg) - latencyInBeat;
        }
        if (Math.floor(msg) !== intBeat) {
            blink();
            intBeat = Math.floor(msg);
            $('#beat').html(intBeat);

        }
        if (msg > previousBeep + 1) {
            previousBeep++;
            console.log(msg);
            beep();
        }
    });
    socket.on('handshakeOK', function () {
        ready = true;
    });

</script>


</html>