<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Link</title>
    <link rel="stylesheet" type="text/css" href="../static/style/bootstrap-4.4.1.min.css"/>
    <link rel="stylesheet" type="text/css" href="../static/style/style.css"/>
    <link rel="stylesheet" type="text/css" href="../static/style/styleLink.css"/>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../static/js/jquery-3.4.1.min.js"></script>
    <script src="../static/jquery-ui.min.js"></script>
    <script src="../static/jquery.ui.touch-punch.min.js"></script>
    <script src="../static/js/lowLag.js"></script>
    <script src="../static/js/howler.min.js"></script>
    <script src="../static/js/soundmanager2-nodebug-jsmin.js"></script>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
    <style>
        .ui-slider {
            margin-top: 20px;
            height: 7px;
            width: 100%;
            position: relative;
            border: none;
            background: #ff5b63;
        }

        .ui-state-default, .ui-widget-content .ui-state-default, .ui-widget-header .ui-state-default {
            background: #ff5b63;
            border-radius: 25px;
            outline: none;
            border: 2px solid #fff;
            position: absolute;
            top: -10px;
        }

        .ui-slider-horizontal .ui-slider-range {
            background: #e9ecf1
        }

        #custom-handle {
            width: 3em;
            height: 1.6em;
            top: 50%;
            margin-top: -.8em;
            text-align: center;
            line-height: 1.6em;
        }
    </style>
</head>

<body>

<div class="main card">
    <div class="row">
        <div class="col-12">
            Tempo<br/>
            <span id="tempo"></span>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            Beat<br/>
            <span id="beat"></span>
        </div>
        <div class="col-6">
            Phase<br/>
            <span id="phase"></span>
        </div>
    </div>
</div>


<div id="light" class="blink">
</div>


<div class="settings card">
    <table>
        <tr>
            <td colspan="2">
                <h4>Audio</h4>
            </td>
        </tr>
        <tr>
            <td class="colSettingDescription">
                Audio
            </td>
            <td class="colSettingToggle align-items-center">
                <label class="switch">
                    <input type="checkbox" id="audioSwitch" onclick="audioToggle()" autocomplete="off">
                    <span class="slider round"></span>
                </label>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <h4>Latency</h4>
            </td>
        </tr>
        <tr>
            <td class="colSettingDescription">
                Latency Compensation
            </td>
            <td class="colSettingToggle align-items-center">
                <label class="switch">
                    <input type="checkbox" id="latencyCompensationSwitch" autocomplete="off"
                           onclick="latencyCompensationToggle()">
                    <span class="slider round"></span>
                </label>
            </td>
        </tr>
    </table>
    <div class="row justify-content-center" style="margin-top: 1em;">
        <div class="col-3">
            <button type="button" id="minusButton" class="btn btn-primary" style="padding-top: 0;padding-bottom: 0.1em;">-</button>
        </div>
        <div class="col-6" id="latencyRow" style="padding-right: 0; padding-left: 0">
            <h5 style="margin-bottom: 0; vertical-align:middle; display: inline"><span class="latencyLabel"></span> s</h5>
        </div>
        <div class="col-3">
            <button type="button" id="plusButton" class="btn btn-primary" style="padding-top: 0;padding-bottom: 0.1em;">+</button>
        </div>
    </div>
    <input type="range" min="0" max="0.5" step="0.001" id="latencySlider" autocomplete="off">
</div>


<footer></footer>
</body>


<script type="application/javascript">
    //load the footer
    $.ajax({
        url: window.location.href.substring(0, window.location.href.length - 4) + "footer",
        type: 'get',
        success: function (response) {
            // Add response in mainPage
            $('footer').html(response);
        },
        async: true
    });

    //latency that will be set from the server
    let latency = LATENCY_TO_REPLACE;
    let tempo = 120;
    $(function () {
        var handle = $("#custom-handle");
        $("#slider").slider({
            min: 0,
            max: 300,
            step: 1,
            create: function () {
                handle.text($(this).slider("value"));
            },
            slide: function (event, ui) {
                handle.text(ui.value);
                latency = ui.value / 1000;
                latencyInBeat = (tempo / 60) * (latency);
                console.log(latency);
                previousBeep = Math.ceil(previousBeep) - latencyInBeat;
                $('.latencyLabel').html(latency);
            }
        });
    });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    //socket
    const socket = io();

    //audio parameters
    let sample;
    let isAudioOn = false;

    //latency parameters
    let isLatencyCompensationEnabled;
    let latencyInBeat;
    let previousBeep = -1;


    //other parameters
    let intBeat = -1;
    let intPhase = -1;

    lowLag.init({'urlPrefix': '../static/sounds/'});
    lowLag.load(["sample.mp3", "sample.ogg"], "sample");
    sample = new Howl({src: ['../static/sounds/sample.mp3'], html5: true});


    //function to activate dedactivate the audio
    let audioToggle = function () {
        isAudioOn = isAudioOn !== true;
    }

    //function to activate dedactivate the latency compensation
    let latencyCompensationToggle = function () {
        isLatencyCompensationEnabled = isLatencyCompensationEnabled !== true;
    }


    //function to make the .blink class blink
    function blink() {
        const $blink = $('.blink');
        $blink.addClass("active");
        setTimeout(() => {
            $blink.removeClass("active");
        }, 100);
    }

    //function to play the sample if audio is on
    function beep() {
        if (isAudioOn === true) {
            //sample.play();
            lowLag.play('sample');
        }
    }


    //init of socket.io
    socket.on('init', function (msg) {
        //manage latency
        tempo = msg.tempo;
        latency = latency = Math.round(latency*Math.pow(10,3))/Math.pow(10,3);
        latencyInBeat = (msg.tempo / 60) * (latency);
        previousBeep = Math.ceil(msg.beat) - latencyInBeat;

        //update values
        intBeat = Math.floor(msg.beat);
        $('#beat').html(intBeat);

        intPhase = Math.floor(msg.phase);
        $('#phase').html(intPhase);

        $('#tempo').html(msg.tempo);
    });


    //when tempo change
    socket.on('tempo', function (msg) {
        //update the parameters for latency
        tempo = msg;
        latencyInBeat = (msg / 60) * (latency);
        console.log(latency);
        previousBeep = Math.ceil(previousBeep) - latencyInBeat;

        //update tempo in the page
        $('#tempo').html(msg);
    });

    //received beat and phase
    socket.on('beatPhase', function (msg) {
        //Ricalibro con "date"
        //let val = ((Date.now() - msg.date))/1000;
        /*if(val > 0){
          msg.beat = msg.beat + val*tempo/60;
          // %4 sarebbe in realtà modulo quanto è il tempo 4/4 in questo caso
          msg.phase = (msg.phase + val*tempo/60)%4;
        }*/
        //$('#tempo').html(tempo + ' ' + val);
        //console.log(val + ' ' + (val*tempo/60));
        //if the beat is changed
        if ((Math.floor(msg.beat) !== intBeat)) {
            //blink
            blink();
            //play the sample if latency compensation is disabled
            if (isLatencyCompensationEnabled === false) {
                beep();
            }
            //update the page
            intBeat = Math.floor(msg.beat);
            $('#beat').html(intBeat);

        }

        //play the sample before the exact beat of the latency amount
        //console.log(previousBeep);
        if ((msg.beat > previousBeep + 1)) {
            previousBeep++;
            //previousBeep è aumentato di 1
            if (isLatencyCompensationEnabled === true && (Math.abs(msg.beat - previousBeep) < ((tempo / 60) * 0.01))) {
                beep();
            }
        }

        //update the phase
        if (Math.floor(msg.phase) !== intPhase) {
            intPhase = Math.floor(msg.phase);
            $('#phase').html(intPhase);
        }
    });


    //functions to disable/enable latency compensation
    let disableLatencyCompensation = function () {
        socket.emit("disableLatencyCompensation");
    }
    socket.on('disableLatencyCompensation', function () {
        isLatencyCompensationEnabled = false;
        document.getElementById("latencyCompensationSwitch").checked = false;
    });
    let enableLatencyCompensation = function () {
        socket.emit("enableLatencyCompensation");
    }
    socket.on('enableLatencyCompensation', function () {
        isLatencyCompensationEnabled = true;
        document.getElementById("latencyCompensationSwitch").checked = true;
    });

    $('.latencyLabel').html(latency);
    $('#latencySlider').val(latency);
    var slider = document.getElementById("latencySlider");
    slider.oninput = function () {
        latency = this.value;
        latencyInBeat = (tempo / 60) * (latency);
        previousBeep = Math.ceil(previousBeep) - latencyInBeat;
        $('.latencyLabel').html(latency);
        console.log(latency);
    }
    let minusButton = document.getElementById("minusButton");
    minusButton.onclick = function () {
        latency = latency - 0.001;
        latency = Math.round(latency*Math.pow(10,3))/Math.pow(10,3);
        latencyInBeat = (tempo / 60) * (latency);
        previousBeep = Math.ceil(previousBeep) - latencyInBeat;
        $('.latencyLabel').html(latency);
        console.log(latency);
    }
    let plusButton = document.getElementById("plusButton");
    plusButton.onclick = function () {
        latency = latency + 0.001;
        latency = Math.round(latency*Math.pow(10,3))/Math.pow(10,3);
        latencyInBeat = (tempo / 60) * (latency);
        previousBeep = Math.ceil(previousBeep) - latencyInBeat;
        $('.latencyLabel').html(latency);
        console.log(latency);
    }
</script>


</html>
